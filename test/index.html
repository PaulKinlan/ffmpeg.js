<!DOCTYPE html>
<html>
<script src="./ringbuffer.js"></script>
<script>

const init = async () => {
  const stdinBuffer = RingBuffer.create(100 * 1024);
  let response = await fetch('./test.webm');
  let testData = new Uint8Array(await response.arrayBuffer());

  let worker = new Worker("../ffmpeg-worker-webm.js");
  worker.postMessage({
    type: "init",
    stdin: stdinBuffer.buffer
  });

  worker.addEventListener("message", function (msg) {
    switch (msg.data.type) {
      case "stdout":
        console.log(msg.data);
        break;
      case "stderr":
        console.log(msg.data);
        break;
      case "ready":
        worker.postMessage({
          type: "run",
          arguments: [
            "-f", "webm",
            "-i", "/dev/stdin",
            "-vcodec", "webm",
            "-frames:v", "5", "-c:v", "libvpx",
            "-an",
            "out.webm",
          ],
          MEMFS: [{ name: "test.webm", data: testData }],
        });
        break;
      case "done":
        worker.terminate();
        var mem = msg.data.data.MEMFS;
        console.log(mem[0])
        break;
    }
  });

  let offset = 0;
  let len = 0;

  processData = () => {
    // Pump the data in to the buffer.
    len = stdinBuffer.remaining;
    if (len !== 0) {
      // Buffer is full. Spin.
      const data = testData.slice(offset, offset + len);
      stdinBuffer.append(data);
      offset = offset + len;
    }

    if (offset < testData.length) setTimeout(processData, 1);
  }

  setTimeout(processData,1);
};

init()
</script>

</html>